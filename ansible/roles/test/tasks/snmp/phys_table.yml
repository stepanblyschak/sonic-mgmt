- set_fact:
    chassis_id: "1"
    sensor_partial_oids: {
      "Temperature": 1,
      "Voltage": 2,
      "Rx1Power": 11,
      "Rx2Power": 21,
      "Rx3Power": 31,
      "Rx4Power": 41,
      "Tx1Bias": 12,
      "Tx2Bias": 22,
      "Tx3Bias": 32,
      "Tx4Bias": 42
    }

- name: Check chassis entity exists in snmp
  fail: msg="No chassis entry in Physical Table MIB"
  when: "{{ chassis_id not in snmp_physical_entities or snmp_physical_entities[chassis_id].entPhysClass != 3 }}"

- debug:
    msg: "{{ snmp_physical_entities.keys()  }}"

- name: Check all transceivers present in Entity MIB
  fail:
    msg: '{{ (((item.value.name.split("Ethernet")[-1] | int + 1) * 1000) | string) }}'
  when: '{{ (((item.value.name.split("Ethernet")[-1] | int + 1) * 1000) | string) not in snmp_physical_entities.keys() }}'
  with_dict:
      minigraph_ports

- name: Check all transceiver DOM sensors present in Entity MIB
  fail:
  when: '{{ ((((item[0].name.split("Ethernet")[-1] | int + 1) * 1000) + item[1]) | string) not in snmp_physical_entities.keys() }}'
  with_nested:
      - "{{ minigraph_ports.values() }}"
      - "{{ sensor_partial_oids.values() }}"

- name: Check all transceiver DOM sensors present in Entity Sensor MIB
  fail:
  when: '{{ ((((item[0].name.split("Ethernet")[-1] | int + 1) * 1000) + item[1]) | string) not in snmp_sensors.keys() }}'
  with_nested:
      - "{{ minigraph_ports.values() }}"
      - "{{ sensor_partial_oids.values() }}"

